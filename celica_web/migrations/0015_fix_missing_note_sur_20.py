# Generated by Django 5.2.1 on 2025-07-01 10:28

from django.db import migrations
from django.core.validators import MinValueValidator, MaxValueValidator
import django.db.models


def add_note_sur_20_if_missing(apps, schema_editor):
    """
    Ajoute la colonne note_sur_20 Ã  la table celica_web_resultat si elle n'existe pas
    """
    db_alias = schema_editor.connection.alias
    with schema_editor.connection.cursor() as cursor:
        # VÃ©rifier si la colonne existe dÃ©jÃ 
        cursor.execute("""
            SELECT COUNT(*)
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = DATABASE()
            AND TABLE_NAME = 'celica_web_resultat'
            AND COLUMN_NAME = 'note_sur_20'
        """)
        
        column_exists = cursor.fetchone()[0] > 0
        
        if not column_exists:
            print("ðŸ”§ Ajout de la colonne note_sur_20 Ã  la table celica_web_resultat...")
            cursor.execute("""
                ALTER TABLE celica_web_resultat 
                ADD COLUMN note_sur_20 DOUBLE NULL 
                COMMENT 'Note ramenÃ©e sur 20'
            """)
            print("âœ… Colonne note_sur_20 ajoutÃ©e avec succÃ¨s")
        else:
            print("âœ… La colonne note_sur_20 existe dÃ©jÃ ")


def remove_note_sur_20(apps, schema_editor):
    """
    Supprime la colonne note_sur_20 (rollback)
    """
    with schema_editor.connection.cursor() as cursor:
        # VÃ©rifier si la colonne existe avant de la supprimer
        cursor.execute("""
            SELECT COUNT(*)
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = DATABASE()
            AND TABLE_NAME = 'celica_web_resultat'
            AND COLUMN_NAME = 'note_sur_20'
        """)
        
        column_exists = cursor.fetchone()[0] > 0
        
        if column_exists:
            print("ðŸ”§ Suppression de la colonne note_sur_20...")
            cursor.execute("ALTER TABLE celica_web_resultat DROP COLUMN note_sur_20")
            print("âœ… Colonne note_sur_20 supprimÃ©e")


class Migration(migrations.Migration):

    dependencies = [
        ('celica_web', '0014_fix_apropos_table'),
    ]

    operations = [
        migrations.RunPython(
            add_note_sur_20_if_missing,
            remove_note_sur_20,
            hints={'verbosity': 2}
        ),
    ]
