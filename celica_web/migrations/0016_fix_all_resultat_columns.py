# Generated by Django 5.2.1 on 2025-07-01 10:30

from django.db import migrations


def fix_resultat_columns(apps, schema_editor):
    """
    Corrige la structure de la table celica_web_resultat en ajoutant les colonnes manquantes
    """
    with schema_editor.connection.cursor() as cursor:
        print("ðŸ”§ Correction de la structure de la table celica_web_resultat...")
        
        # VÃ©rifier et ajouter la colonne commentaires
        cursor.execute("""
            SELECT COUNT(*)
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = DATABASE()
            AND TABLE_NAME = 'celica_web_resultat'
            AND COLUMN_NAME = 'commentaires'
        """)
        
        if cursor.fetchone()[0] == 0:
            print("  âž¤ Ajout de la colonne 'commentaires'...")
            cursor.execute("""
                ALTER TABLE celica_web_resultat 
                ADD COLUMN commentaires LONGTEXT NULL 
                COMMENT 'Commentaires sur le rÃ©sultat'
            """)
            print("    âœ… Colonne 'commentaires' ajoutÃ©e")
        else:
            print("    âœ… Colonne 'commentaires' existe dÃ©jÃ ")
        
        # VÃ©rifier et ajouter la colonne temps_ecoule
        cursor.execute("""
            SELECT COUNT(*)
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = DATABASE()
            AND TABLE_NAME = 'celica_web_resultat'
            AND COLUMN_NAME = 'temps_ecoule'
        """)
        
        if cursor.fetchone()[0] == 0:
            print("  âž¤ Ajout de la colonne 'temps_ecoule'...")
            cursor.execute("""
                ALTER TABLE celica_web_resultat 
                ADD COLUMN temps_ecoule INT UNSIGNED NULL 
                COMMENT 'Temps Ã©coulÃ© en minutes'
            """)
            print("    âœ… Colonne 'temps_ecoule' ajoutÃ©e")
        else:
            print("    âœ… Colonne 'temps_ecoule' existe dÃ©jÃ ")
            
        print("âœ… Structure de la table celica_web_resultat corrigÃ©e")


def reverse_fix_resultat_columns(apps, schema_editor):
    """
    Supprime les colonnes ajoutÃ©es (rollback)
    """
    with schema_editor.connection.cursor() as cursor:
        print("ðŸ”§ Suppression des colonnes ajoutÃ©es...")
        
        # Supprimer commentaires si elle existe
        cursor.execute("""
            SELECT COUNT(*)
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = DATABASE()
            AND TABLE_NAME = 'celica_web_resultat'
            AND COLUMN_NAME = 'commentaires'
        """)
        
        if cursor.fetchone()[0] > 0:
            cursor.execute("ALTER TABLE celica_web_resultat DROP COLUMN commentaires")
            print("  âœ… Colonne 'commentaires' supprimÃ©e")
        
        # Supprimer temps_ecoule si elle existe
        cursor.execute("""
            SELECT COUNT(*)
            FROM INFORMATION_SCHEMA.COLUMNS 
            WHERE TABLE_SCHEMA = DATABASE()
            AND TABLE_NAME = 'celica_web_resultat'
            AND COLUMN_NAME = 'temps_ecoule'
        """)
        
        if cursor.fetchone()[0] > 0:
            cursor.execute("ALTER TABLE celica_web_resultat DROP COLUMN temps_ecoule")
            print("  âœ… Colonne 'temps_ecoule' supprimÃ©e")


class Migration(migrations.Migration):

    dependencies = [
        ('celica_web', '0015_fix_missing_note_sur_20'),
    ]

    operations = [
        migrations.RunPython(
            fix_resultat_columns,
            reverse_fix_resultat_columns,
            hints={'verbosity': 2}
        ),
    ]
