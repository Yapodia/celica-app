{% extends 'celicaweb/base.html' %}
{% load static %}

{% block title %}{{ test.titre }} - Question {{ question_actuelle_numero }}/{{ total_questions }} - CelicaWeb{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}


{% block extra_css %}
<style>
.violation-alert {
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    background: #dc3545;
    color: white;
    padding: 15px;
    border-radius: 5px;
    z-index: 10000;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

/* D√©sactiver la s√©lection de texte */
* {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
    user-drag: none;
}

/* Permettre la s√©lection dans les champs de saisie */
input, textarea, [contenteditable="true"] {
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    user-select: text;
}

body {
    background: #f8f9fa;
    min-height: 100vh;
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
}

.test-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 2rem;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    width: 100%;
}

/* Header avec score et timer */
.test-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3rem;
    font-size: 1.1rem;
    font-weight: 600;
}

.score-display {
    color: #333;
}

.timer-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #28a745;
}

.timer-display.warning {
    color: #ffc107;
}

.timer-display.danger {
    color: #dc3545;
}

/* Question principale */
.question-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    max-width: 100%;
}

.question-text {
    font-size: 1.4rem;
    font-weight: 500;
    color: #333;
    margin-bottom: 2.5rem;
    line-height: 1.6;
    text-align: left;
    padding: 0;
}

/* Options de r√©ponse */
.answers-list {
    margin-bottom: 3rem;
}

.answer-item {
    background: #e9ecef;
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 1.2rem 1.5rem;
    margin-bottom: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 1rem;
    color: #333;
}

.answer-item:hover {
    background: #dee2e6;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.answer-item.selected {
    background: #d1ecf1;
    border-color: #28a745;
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    animation: selectionPulse 0.3s ease-out;
}

@keyframes selectionPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

.answer-letter {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
    flex-shrink: 0;
}

.answer-item.selected .answer-letter {
    background: #28a745;
}

.answer-text {
    flex: 1;
    font-weight: 500;
    line-height: 1.5;
}

/* Zone de texte libre */
.text-input-area {
    margin-bottom: 3rem;
}

.text-answer {
    width: 100%;
    min-height: 200px;
    padding: 1.5rem;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    font-family: inherit;
    font-size: 1rem;
    resize: vertical;
    transition: border-color 0.2s ease;
    background: white;
    color: #333;
    line-height: 1.6;
}

.text-answer:focus {
    outline: none;
    border-color: #28a745;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

.character-counter {
    text-align: right;
    color: #6c757d;
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

/* Navigation */
.main-navigation {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
}

.nav-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.nav-btn:hover {
    background: #5a6268;
}

.nav-btn:disabled {
    background: #dee2e6;
    cursor: not-allowed;
}

.next-button {
    background: #28a745;
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: 600;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.next-button:hover {
    background: #218838;
}

/* Indicateur de sauvegarde */
.save-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 0.9rem;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.save-indicator.show {
    opacity: 1;
    transform: translateY(0);
}

.save-indicator.saving {
    background: #ffc107;
    color: #212529;
}

/* Responsive */
@media (max-width: 768px) {
    .test-container {
        padding: 1rem;
    }
    
    .question-text {
        font-size: 1.2rem;
    }
    
    .answer-item {
        padding: 1rem;
    }
    
    .main-navigation {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Alerte de violation de s√©curit√© -->
<div id="violation-alert" class="violation-alert">
    <i class="fas fa-exclamation-triangle"></i>
    <span id="violation-message">Violation de s√©curit√© d√©tect√©e</span>
</div>

<div class="test-container">
    <!-- Header avec question et timer -->
    <div class="test-header">
        <div class="question-x">Question {{ question_actuelle_numero }}</div>
        <div class="timer-display" id="timerDisplay">
            <i class="fas fa-clock"></i>
            <span id="timerTime"></span>
        </div>
    </div>

    <!-- Section de la question -->
    <div class="question-section">
        <!-- √ânonc√© de la question -->
        <div class="question-text">
            {% if question.enonce %}
                {{ question.enonce|linebreaks }}
            {% else %}
                Question {{ question_actuelle_numero }} - {{ question.id }}
            {% endif %}
        </div>

        <!-- Image de la question -->
        {% if question.image %}
            <div class="question-image-container" style="text-align: center; margin: 2rem 0;">
                <img src="{{ question.image.url }}" 
                     alt="Image de la question {{ question_actuelle_numero }}" 
                     class="question-image" 
                     style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
            </div>
        {% endif %}

        <!-- Formulaire -->
        <form method="post" id="questionForm" action="">
            {% csrf_token %}
            <input type="hidden" name="question_id" value="{{ question.id }}">
            <input type="hidden" name="action" value="save_and_next">
            
            {% if question.type_question == 'QCM' %}
                <!-- R√©ponses QCM -->
                <div class="answers-list">
                    {% for reponse in reponses_ordonnees %}
                    <div class="answer-item">
                        <input type="radio" 
                               name="reponse_qcm" 
                               value="{{ reponse.id }}"
                               id="reponse_{{ reponse.id }}"
                               {% if reponse.id in reponses_utilisateur %}checked{% endif %}>
                        <label for="reponse_{{ reponse.id }}" class="answer-text">
                            {{ reponse.texte }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}
            
            <!-- R√©ponse libre -->
            {% if question.type_question == 'QRL' %}
            <div class="text-input-area">
                <textarea name="reponse_libre" 
                          class="text-answer" 
                          placeholder="Tapez votre r√©ponse ici..."
                          maxlength="2000" 
                          id="textAnswer">{{ reponse_libre|default:"" }}</textarea>
                <div class="character-counter">
                    <span id="charCount">{{ reponse_libre|length|default:0 }}</span>/2000 caract√®res
                </div>
            </div>
            {% endif %}
            
            <!-- Bouton Terminer uniquement -->
            <div class="main-navigation">
                {% if not question_suivante %}
                    <button type="submit" name="action" value="finish_test" class="next-button">
                        <i class="fas fa-check-circle"></i>
                        Terminer le test
                    </button>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Navigation secondaire -->
    <div class="secondary-nav" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
        <div style="flex: 1; display: flex;">
            <button class="nav-btn" disabled style="opacity:0.5;cursor:not-allowed;">
                <i class="fas fa-chevron-left"></i>
                Pr√©c√©dent
            </button>
        </div>
        <div style="flex: 1; display: flex; justify-content: center;">
            <span class="question-counter" style="font-weight: 600;">{{ question_actuelle_numero }} / {{ total_questions }}</span>
        </div>
        <div style="flex: 1; display: flex; justify-content: flex-end;">
            {% if question_suivante %}
            <form method="post" id="navNextForm" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="question_id" value="{{ question.id }}">
                <input type="hidden" name="action" value="save_and_next">
                <button type="submit" class="nav-btn">
                    Suivant
                    <i class="fas fa-arrow-right"></i>
                </button>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<!-- Indicateur de sauvegarde -->
<div class="save-indicator" id="saveIndicator">
    <span id="saveText">Sauvegard√© ‚úì</span>
</div>

<script>
// GESTION CSRF ET S√âCURIT√â
console.log('üöÄ SYST√àME DE S√âCURIT√â INITIALIS√â');

// Fonction pour obtenir le token CSRF
function getCSRFToken() {
    // Essayer d'abord le meta tag
    const metaToken = document.querySelector('meta[name=csrf-token]');
    if (metaToken && metaToken.getAttribute('content')) {
        return metaToken.getAttribute('content');
    }
    
    // Sinon, essayer le champ cach√© dans le formulaire
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token && token.value) {
        return token.value;
    }
    
    // En dernier recours, essayer de r√©cup√©rer depuis les cookies
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    
    console.warn('‚ö†Ô∏è TOKEN CSRF NON TROUV√â');
    return '';
}

// Variables de surveillance
const testSessionKey = 'violationCount_' + {{ test.id }} + '_' + {{ request.user.id }};
const maxViolations = 3;

// R√âCUP√âRER LE COMPTEUR DEPUIS LE SERVEUR
console.log('üîç R√âCUP√âRATION DU COMPTEUR DEPUIS LE SERVEUR');
let violationCount = 0;

// Fonction pour r√©cup√©rer le compteur depuis le serveur
function getViolationCount() {
    console.log('üîÑ R√©cup√©ration du compteur depuis le serveur...');
    fetch('/test/security-violation/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        console.log('üì° R√©ponse re√ßue:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üìä Donn√©es re√ßues:', data);
        if (data.violation_count !== undefined) {
            violationCount = data.violation_count;
            console.log(`üìä COMPTEUR R√âCUP√âR√â DEPUIS LE SERVEUR: ${violationCount}/${maxViolations}`);
            
            // V√©rifier si le test doit √™tre termin√©
            if (violationCount >= maxViolations) {
                console.log('üö® VIOLATIONS D√âJ√Ä D√âPASS√âES - TERMINATION DU TEST');
                alert('Test termin√© automatiquement en raison de violations r√©p√©t√©es.');
                window.location.href = '{% url "celica_web:test_terminated" %}';
            }
        } else {
            console.log('‚ö†Ô∏è Pas de compteur dans la r√©ponse');
        }
    })
    .catch(error => {
        console.warn('‚ùå Erreur lors de la r√©cup√©ration du compteur:', error);
        // Fallback vers localStorage
        violationCount = parseInt(localStorage.getItem(testSessionKey) || '0');
        console.log(`üìä COMPTEUR FALLBACK: ${violationCount}/${maxViolations}`);
    });
}

// R√©cup√©rer le compteur au chargement
getViolationCount();

// Variables pour √©viter les fausses violations lors des transitions de page
let isPageTransitioning = false;
let isFormSubmitting = false;

console.log(`üìä COMPTEUR ACTUEL: ${violationCount}/${maxViolations}`);
console.log(`üîë CL√â DE SESSION: ${testSessionKey}`);
console.log(`üéØ LIMITE DE VIOLATIONS: ${maxViolations}`);



// Syst√®me anti-spam pour √©viter les violations multiples
let lastViolationTime = 0;
const violationCooldown = 2000; // 2 secondes entre les violations

// Fonction de gestion des violations
function handleSecurityViolation(violationType, details = {}) {
    const now = Date.now();
    
    // √âviter les violations trop rapproch√©es
    if (now - lastViolationTime < violationCooldown) {
        console.log(`‚è∞ VIOLATION IGNOR√âE (trop rapide): ${violationType}`);
        return;
    }
    
    lastViolationTime = now;
    console.log(`üö® VIOLATION D√âTECT√âE: ${violationType}`);
    console.log(`üìä COMPTEUR ACTUEL: ${violationCount}/${maxViolations}`);
    
    // Afficher l'alerte imm√©diatement avec le compteur actuel + 1
    const alertElement = document.getElementById('violation-alert');
    if (alertElement) {
        const messageElement = document.getElementById('violation-message');
        if (messageElement) {
            const currentViolationCount = violationCount + 1;
            messageElement.textContent = 'Violation de s√©curit√© d√©tect√©e (' + currentViolationCount + '/' + maxViolations + ')';
            console.log(`üìä AFFICHAGE ALERTE: ${currentViolationCount}/${maxViolations}`);
        }
        alertElement.style.display = 'block';
        console.log('‚úÖ ALERTE AFFICH√âE');
        
        setTimeout(function() {
            alertElement.style.display = 'none';
        }, 5000);
    } else {
        console.error('‚ùå √âL√âMENT D\'ALERTE NON TROUV√â');
    }
    
    // Envoyer la violation au serveur
    const requestData = {
        violation: 'Violation de type: ' + violationType,
        violation_type: violationType,
        url: window.location.href,
        violation_count: violationCount
    };
    
    console.log('üì§ Envoi de la violation au serveur:', requestData);
    
    fetch('/test/security-violation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('üì° R√©ponse re√ßue:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üìä Donn√©es re√ßues du serveur:', data);
        
        // Mettre √† jour le compteur local avec la r√©ponse du serveur
        if (data.violation_count !== undefined) {
            violationCount = data.violation_count;
            console.log(`üìä COMPTEUR MIS √Ä JOUR: ${violationCount}/${maxViolations}`);
            
            // Mettre √† jour l'alerte avec le compteur r√©el
            const alertElement = document.getElementById('violation-alert');
            if (alertElement) {
                const messageElement = document.getElementById('violation-message');
                if (messageElement) {
                    messageElement.textContent = 'Violation de s√©curit√© d√©tect√©e (' + violationCount + '/' + maxViolations + ')';
                    console.log(`üìä ALERTE MISE √Ä JOUR: ${violationCount}/${maxViolations}`);
                }
            }
        }
        
        // V√©rifier si le test doit √™tre termin√©
        if (data.status === 'terminated' || violationCount >= maxViolations) {
            console.log('üö® TEST TERMIN√â PAR LE SERVEUR');
            
            // D√©sactiver tous les √©l√©ments imm√©diatement
            document.querySelectorAll('input, button, textarea').forEach(function(el) {
                el.disabled = true;
                console.log('üîí √âl√©ment d√©sactiv√©:', el);
            });
            
            // Afficher l'alerte finale
            alert('Test termin√© automatiquement en raison de violations r√©p√©t√©es.');
            
            // Redirection imm√©diate
            if (data.redirect) {
                window.location.href = data.redirect;
            } else {
                window.location.href = '{% url "celica_web:test_terminated" %}';
            }
        }
    })
    .catch(function(error) {
        console.warn('‚ùå Erreur lors de l\'enregistrement de la violation:', error);
    });
}

// √âV√âNEMENTS DE S√âCURIT√â ET GESTION DES R√âPONSES
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ INITIALISATION COMPL√àTE DU SYST√àME');
    
    // Marquer que la page vient de se charger (√©viter les fausses violations)
    isPageTransitioning = true;
    setTimeout(() => {
        isPageTransitioning = false;
        console.log('‚úÖ P√âRIODE DE TRANSITION TERMIN√âE');
    }, 1000);
    
    // === √âV√âNEMENTS DE S√âCURIT√â ===
    console.log('üîí ATTACHEMENT DES √âV√âNEMENTS DE S√âCURIT√â');
    
    // 1. CLIC DROIT
    document.addEventListener('contextmenu', function(e) {
        console.log('üñ±Ô∏è CLIC DROIT D√âTECT√â');
        e.preventDefault();
        handleSecurityViolation('right_click');
        return false;
    });
    
    // 2. RACCOURCIS CLAVIER
    document.addEventListener('keydown', function(e) {
        // Touches interdites
        const forbiddenKeys = ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'PrintScreen'];
        if (forbiddenKeys.includes(e.key)) {
            console.log(`‚å®Ô∏è TOUCHE INTERDITE: ${e.key}`);
            e.preventDefault();
            handleSecurityViolation('keyboard_shortcut', { key: e.key });
            return false;
        }
        
        // Combinaisons Ctrl
        if (e.ctrlKey) {
            const ctrlCombos = ['c', 'v', 'x', 'a', 'z', 'y', 's', 'p', 'u', 'i', 'j', 'k'];
            if (ctrlCombos.includes(e.key.toLowerCase())) {
                console.log(`‚å®Ô∏è CTRL+${e.key} D√âTECT√â`);
                e.preventDefault();
                handleSecurityViolation('keyboard_shortcut', { key: e.key, ctrl: true });
                return false;
            }
        }
    });
    
    // 3. COPIE/COLLAGE
    document.addEventListener('copy', function(e) {
        console.log('üìã COPIE D√âTECT√âE');
        e.preventDefault();
        handleSecurityViolation('copy_attempt');
        return false;
    });
    
    document.addEventListener('paste', function(e) {
        console.log('üìã COLLAGE D√âTECT√â');
        e.preventDefault();
        handleSecurityViolation('paste_attempt');
        return false;
    });
    
    // 4. CHANGEMENT D'ONGLET
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && !isPageTransitioning && !isFormSubmitting) {
            console.log('üìë CHANGEMENT D\'ONGLET D√âTECT√â');
            handleSecurityViolation('tab_switch');
        } else if (document.hidden) {
            console.log('üìë CHANGEMENT D\'ONGLET IGNOR√â (transition de page)');
        }
    });
    
    // 5. PERTE DE FOCUS
    window.addEventListener('blur', function() {
        if (!isPageTransitioning && !isFormSubmitting) {
            console.log('ü™ü PERTE DE FOCUS D√âTECT√âE');
            handleSecurityViolation('window_blur');
        } else {
            console.log('ü™ü PERTE DE FOCUS IGNOR√âE (transition de page)');
        }
    });
    
    console.log('‚úÖ √âV√âNEMENTS DE S√âCURIT√â ATTACH√âS');
    
    // === GESTION DES R√âPONSES ===
    console.log('üéØ INITIALISATION DE LA GESTION DES R√âPONSES');
    
    const answerItems = document.querySelectorAll('.answer-item');
    const form = document.getElementById('questionForm');
    const saveIndicator = document.getElementById('saveIndicator');
    const textAnswer = document.getElementById('textAnswer');
    const charCount = document.getElementById('charCount');
    
    console.log(`üìä √âL√âMENTS TROUV√âS:`);
    console.log(`- R√©ponses: ${answerItems.length}`);
    console.log(`- Formulaire: ${form ? 'OUI' : 'NON'}`);
    console.log(`- Indicateur: ${saveIndicator ? 'OUI' : 'NON'}`);
    
    // Initialiser les r√©ponses s√©lectionn√©es
    answerItems.forEach((item, index) => {
        const input = item.querySelector('input');
        if (input && input.checked) {
            item.classList.add('selected');
            console.log(`‚úÖ R√©ponse ${index + 1} d√©j√† s√©lectionn√©e`);
        }
    });

    // Fonction pour s'assurer que le token CSRF est pr√©sent et valide
    function ensureCSRFToken(form) {
        let csrfToken = form.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            form.appendChild(csrfToken);
        }
        
        // R√©cup√©rer le token depuis le meta tag en priorit√©
        const metaToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
        if (metaToken) {
            csrfToken.value = metaToken;
            console.log('‚úÖ TOKEN CSRF R√âCUP√âR√â DEPUIS LE META TAG');
        }
        
        // V√©rifier que le token n'est pas vide
        if (!csrfToken.value) {
            console.warn('‚ö†Ô∏è TOKEN CSRF MANQUANT - R√âCUP√âRATION DEPUIS LE COOKIE...');
            // Essayer de r√©cup√©rer depuis le cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    csrfToken.value = value;
                    console.log('‚úÖ TOKEN CSRF R√âCUP√âR√â DEPUIS LE COOKIE');
                    break;
                }
            }
        }
        
        // V√©rification finale
        if (!csrfToken.value) {
            console.error('‚ùå TOKEN CSRF TOUJOURS MANQUANT');
            return false;
        }
        
        console.log('üîë TOKEN CSRF VALIDE:', csrfToken.value.substring(0, 10) + '...');
        return csrfToken.value;
    }

    // Fonction pour rafra√Æchir le token CSRF si n√©cessaire
    function refreshCSRFToken() {
        const metaToken = document.querySelector('meta[name=csrf-token]');
        if (metaToken) {
            const currentToken = metaToken.getAttribute('content');
            // Mettre √† jour tous les formulaires avec le nouveau token
            document.querySelectorAll('form').forEach(form => {
                const csrfInput = form.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfInput) {
                    csrfInput.value = currentToken;
                }
            });
            console.log('üîÑ TOKEN CSRF RAFRA√éCHI');
        }
    }

    // Gestion des clics sur les r√©ponses avec passage automatique
    console.log('üéØ ATTACHEMENT DES √âV√âNEMENTS DE CLIC');
    answerItems.forEach((item, index) => {
        item.addEventListener('click', function(e) {
            console.log(`üñ±Ô∏è CLIC SUR R√âPONSE ${index + 1}`);
            
            const input = this.querySelector('input');
            if (!input) {
                console.log('‚ùå INPUT NON TROUV√â');
                return;
            }

            // Highlight s√©lection imm√©diat
            answerItems.forEach(it => it.classList.remove('selected'));
            this.classList.add('selected');
            input.checked = true;
            console.log(`‚úÖ R√©ponse ${index + 1} s√©lectionn√©e`);

            // Soumettre imm√©diatement la r√©ponse
            const form = document.getElementById('questionForm');
            if (form) {
                console.log('üìù SOUMISSION DU FORMULAIRE');
                
                // S'assurer que le token CSRF est pr√©sent
                const token = ensureCSRFToken(form);
                if (!token) {
                    console.error('‚ùå TOKEN CSRF MANQUANT - RECHARGEMENT DE LA PAGE');
                    alert('Erreur de s√©curit√© d√©tect√©e. La page va √™tre recharg√©e.');
                    window.location.reload();
                    return;
                }
                console.log(`üîë TOKEN CSRF: PR√âSENT (${token.substring(0, 10)}...)`);
                
                form.querySelector('input[name="action"]').value = 'save_and_next';
                
                // Afficher un indicateur de chargement
                const saveIndicator = document.getElementById('saveIndicator');
                if (saveIndicator) {
                    saveIndicator.style.display = 'block';
                    saveIndicator.querySelector('#saveText').textContent = 'Sauvegarde et passage automatique...';
                    console.log('üíæ INDICATEUR DE SAUVEGARDE AFFICH√â');
                }
                
                // D√©sactiver temporairement les clics pour √©viter les doubles soumissions
                answerItems.forEach(item => {
                    item.style.pointerEvents = 'none';
                    item.style.opacity = '0.7';
                });
                console.log('üîí R√âPONSES D√âSACTIV√âES');
                
                // Soumettre le formulaire apr√®s un court d√©lai pour l'effet visuel
                setTimeout(() => {
                    console.log('üöÄ SOUMISSION DU FORMULAIRE');
                    
                    // Marquer que nous sommes en train de soumettre le formulaire
                    isFormSubmitting = true;
                    isPageTransitioning = true;
                    
                    // Rafra√Æchir le token CSRF avant soumission
                    refreshCSRFToken();
                    
                    // V√©rifier une derni√®re fois que le token est pr√©sent
                    const finalToken = ensureCSRFToken(form);
                    if (!finalToken) {
                        console.error('‚ùå TOKEN CSRF MANQUANT - RECHARGEMENT DE LA PAGE');
                        alert('Erreur de s√©curit√© d√©tect√©e. La page va √™tre recharg√©e.');
                        window.location.reload();
                        return;
                    }
                    
                    form.submit();
                }, 300);
            } else {
                console.log('‚ùå FORMULAIRE NON TROUV√â');
            }
        });
        console.log(`‚úÖ √âv√©nement de clic attach√© √† la r√©ponse ${index + 1}`);
    });

    // Gestion du compteur de caract√®res
    if (textAnswer && charCount) {
        textAnswer.addEventListener('input', function() {
            const count = this.value.length;
            charCount.textContent = count;
        });
    }

    // Timer
    console.log('‚è∞ INITIALISATION DU TIMER');
    let tempsRestant = parseInt('{{ temps_restant_seconds|default:60 }}');
    const timerDisplay = document.getElementById('timerDisplay');
    const timerTime = document.getElementById('timerTime');
    
    console.log(`‚è∞ TEMPS RESTANT: ${tempsRestant} secondes`);
    console.log(`‚è∞ TIMER DISPLAY: ${timerDisplay ? 'TROUV√â' : 'NON TROUV√â'}`);
    console.log(`‚è∞ TIMER TIME: ${timerTime ? 'TROUV√â' : 'NON TROUV√â'}`);
    
    if (timerTime && tempsRestant > 0) {
        const timerInterval = setInterval(() => {
            const minutes = Math.floor(tempsRestant / 60);
            const secondes = tempsRestant % 60;
            
            console.log(`‚è∞ TEMPS: ${minutes}m ${secondes.toString().padStart(2,'0')}s`);
            
            if (tempsRestant <= 0) {
                clearInterval(timerInterval);
                console.log('‚è∞ TEMPS √âCOUL√â - SOUMISSION AUTOMATIQUE');
                const form = document.getElementById('questionForm');
                if (form) {
                    form.submit();
                }
            } else {
                timerTime.textContent = `${minutes}m ${secondes.toString().padStart(2,'0')}s`;
                
                if (tempsRestant <= 300) {
                    timerDisplay.className = 'timer-display danger';
                } else if (tempsRestant <= 600) {
                    timerDisplay.className = 'timer-display warning';
                }
            }
            
            tempsRestant--;
        }, 1000);
        console.log('‚úÖ TIMER D√âMARR√â');
    } else {
        console.log('‚ùå TIMER NON D√âMARR√â - √âL√âMENTS MANQUANTS');
    }

    // Gestion de la soumission du formulaire
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üìù SOUMISSION DU FORMULAIRE D√âTECT√âE');
            
            // Marquer que nous sommes en train de soumettre le formulaire
            isFormSubmitting = true;
            isPageTransitioning = true;
            
            // Nettoyer le localStorage lors de la fin du test
            if (e.submitter && e.submitter.value === 'finish_test') {
                console.log('üèÅ FIN DU TEST - NETTOYAGE DU LOCALSTORAGE');
                localStorage.removeItem(testSessionKey);
                localStorage.removeItem(testStartKey);
                console.log('üßπ LocalStorage nettoy√©');
            }
        });
    }
});
</script>
{% endblock %}